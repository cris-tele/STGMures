@page "/PatientFilePage"
@page "/PatientFilePage/{PatientId:int}"

@using StgMures.Shared.DbModels
@inject MudBlazor.ISnackbar snackBar
@inherits PageBehavior

<!--current pacient = selected patient in the patient list page-->
@inject IPatientFileService patientFileService

@inject ISetAppMenuInfos SetAppMenuInfos


<!-- Usually, a patient has only one observation file-->
<!-- But, we a dealing with heart desease type of diagnostoics, and there are too many case when-->
<!-- - The patient stays in hospital for a long periood of time (cases of one year of hospitalisation ) -->
<!-- - Or, more frequently, the patient comes back after a period of years, for another surgery or another treatment scheme, complete investigations... -->
<!-- So, one patient can have more than one file, and also the medical history is important -->
<!-- The last one must be the "default" but the medical team can select and older one -->

<!--edit card-->
<MudCard Elevation="5" >
<!--    <MudCardHeader >  </MudCardHeader> --> <!--Nu stiu daca voi folosi-->
    <MudCardContent >

        <MudPaper Class="d-flex justify-space-between flex-grow-1 gap-4" Elevation="5">
            <MudPaper>
                <MudInputLabel >Nr. Fisa:
                    <MudAutocomplete Disabled="_disabledField" @bind-Value="currentPatientFile.FileNumber" Variant="Variant.Text" Class="m-0"  Margin="Margin.Dense"></MudAutocomplete> <!-- pentru inceput va fi doar o fisa -->
                </MudInputLabel>
            </MudPaper>

            <MudPaper  >
                <MudInputLabel >Inaltime:</MudInputLabel>
                    <MudTextField   Disabled="_disabledField" @bind-Value="currentPatientFile.Height" HelperText="cm" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
                <MudInputLabel >Greutate:</MudInputLabel>
                    <MudTextField   Disabled="_disabledField" @bind-Value="currentPatientFile.Weight" HelperText="kg" Variant="Variant.Text" Margin="Margin.Dense" ></MudTextField>
            </MudPaper>

            <MudPaper >
                <MudInputLabel>B.M.I:</MudInputLabel>
                <MudTextField Disabled="@_disabledField" @bind-Value="currentPatientFile.Bmi" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
                <MudInputLabel>B.S.A:</MudInputLabel>
                <MudTextField Disabled="@_disabledField" @bind-Value="currentPatientFile.Bsa" Variant="Variant.Text" Margin="Margin.Dense"></MudTextField>
            </MudPaper>

            <MudPaper >
                <MudInputLabel>Data Internarii ATI:</MudInputLabel>
                <MudDatePicker Disabled="_disabledField" @bind-Value="currentPatientFile.AtiTakeOverDate" Variant="Variant.Text" Margin="Margin.Dense"></MudDatePicker>
                <MudInputLabel>Data reinternarii ATI:</MudInputLabel>
                <MudDatePicker Disabled="_disabledField" @bind-Value="currentPatientFile.AtiRetakeOverDate" Variant="Variant.Text" Margin="Margin.Dense"></MudDatePicker>
                <MudInputLabel>Nr. Zile ATI:</MudInputLabel>
                <MudNumericField Disabled="true" HideSpinButtons="true"  @bind-Value="currentPatientFile.Atidays" Variant="Variant.Text" Margin="Margin.Dense"></MudNumericField>
            </MudPaper>

            <MudPaper >
                <MudInputLabel>Transfer pe sectie:</MudInputLabel>
                <MudDatePicker Disabled="_disabledField" @bind-Value="currentPatientFile.WardTransferDate" Variant="Variant.Text" Margin="Margin.Dense"></MudDatePicker>
                <MudInputLabel>Retransfer pe sectie:</MudInputLabel>
                <MudDatePicker Disabled="_disabledField" @bind-Value="currentPatientFile.WardRetransferDate"  Variant="Variant.Text" Margin="Margin.Dense"></MudDatePicker>
                <MudInputLabel>Nr. Zile sectie:</MudInputLabel>
                <MudNumericField Disabled="true" HideSpinButtons="true" @bind-Value="currentPatientFile.WardDays" Variant="Variant.Text" Margin="Margin.Dense"></MudNumericField>
            </MudPaper>

            <MudPaper >
                <MudInputLabel>Internare in Spital:</MudInputLabel>
                <MudDatePicker Disabled="_disabledField" @bind-Value="currentPatientFile.HospitalAdmissionDate" Variant="Variant.Text" Margin="Margin.Dense"></MudDatePicker>
                <MudInputLabel>Externare:</MudInputLabel>
                <MudDatePicker Disabled="_disabledField" @bind-Value="currentPatientFile.DischargeDate" Variant="Variant.Text" Margin="Margin.Dense"></MudDatePicker>
            </MudPaper>
    
            <MudPaper >
                <MudInputLabel>Transfer alt spital:</MudInputLabel>
                <MudTextField Disabled="@_disabledField" @bind-Value="currentPatientFile.AnotherHospitalAdmission" Variant="Variant.Outlined" Margin="Margin.Dense" Lines="5"></MudTextField>
            </MudPaper>

        </MudPaper>


    </MudCardContent>

    <MudDivider DividerType="DividerType.FullWidth" Class="border-3 border-solid mud-border-primary" />

    <MudCardActions>
        <MudGrid>
            <MudItem xs="1">
                <MudTooltip Text="Adauga o noua inregistrare">
                    <MudIconButton Disabled="@_disabledBtn" Icon="@Icons.Material.Filled.Add"    Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="AddNewRecord">Adauga</MudIconButton>
                </MudTooltip>

                <MudTooltip Text="Modifica inregistrarea selectata">
                    <MudIconButton Disabled="@_disabledBtn" Icon="@Icons.Material.Filled.Edit"   Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="UpdateRecord">Modifica</MudIconButton>
                </MudTooltip>

                <MudTooltip Text="Sterge inregistrarea selectata">
                    <MudIconButton Disabled="@_disabledBtn" Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="DeleteRecord">Sterge</MudIconButton>
                </MudTooltip>
            </MudItem>
            <MudItem xs="1" /> <!--spacer -->
            <MudItem xs="1">
            <MudTooltip Text="Validare">
                <MudIconButton Disabled="@_disabledBtnValid" Icon="@Icons.Material.Filled.Save" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="ValidateAction">Ok</MudIconButton>
            </MudTooltip>
            <MudTooltip Text="Renuntare">
                <MudIconButton Disabled="@_disabledBtnValid" Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="DisableAll">Cancel</MudIconButton>
            </MudTooltip>
            </MudItem>
            <MudSpacer/> <!--spacer -->

            <!-- butoane detalii -->
            <MudItem xs="1">
            <MudTooltip Text="Diagnostic ">
                    <MudButton EndIcon="@Icons.Material.Filled.DeviceThermostat" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="ValidateAction">Diagnostic</MudButton>
            </MudTooltip>
            </MudItem>
            <MudItem xs="1">
                <MudTooltip Text="ATI">
                    <MudButton EndIcon="@Icons.Material.Filled.AirlineSeatFlat" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="ValidateAction">ATI</MudButton>
            </MudTooltip>
            </MudItem>
            <MudItem xs="1">
                <MudTooltip Text="Operatie ">
                    <MudButton EndIcon="@Icons.Material.Filled.PrecisionManufacturing" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="ValidateAction">Operatie</MudButton>
                </MudTooltip>
            </MudItem>
            <MudItem xs="1">
                <MudTooltip Text="Circuit Extra Corporal">
                    <MudButton EndIcon="@Icons.Material.Filled.VolunteerActivism" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="ValidateAction">CEC</MudButton>
                </MudTooltip>
            </MudItem>
            <MudItem xs="1">
                <MudTooltip Text="Anestezie">
                    <MudButton EndIcon="@Icons.Material.Filled.Vaccines" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="ValidateAction">Anestezie</MudButton>
                </MudTooltip>
            </MudItem>
        </MudGrid>
    </MudCardActions>

</MudCard>
<br />

<MudTabs Outlined="true">
    <MudTabPanel Text="Diagnostic Primar">
        <StgMures.Client.Pages.Categories.ConsumableCategories></StgMures.Client.Pages.Categories.ConsumableCategories>
        <!-- <MudTable @ref="@_table" Hover="true" Dense="true" Striped="true" Elevation="5" Items="@patientsFiles" @bind-customer="currentPatientFile" OnRowClick="@RowClicked" T="PatientFile"> -->
        <!-- NU e cazul, vor fi 2-3 fise max
            <ToolBarContent>
                <MudSpacer />
                <MudTextField @bind-Value="searchString" Placeholder="Cautati o categorie..." Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.currentPatientFile" IconSize="Size.Small" Class="mt-0"></MudTextField>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Nr.Fisa</MudTh>
                <MudTh>Data Fisa</MudTh>
                <MudTh>Data Internarii</MudTh>
                <MudTh>Data Externarii</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd Class="col-1" DataLabel="Id">@context.FileNumber</MudTd>
                <MudTd Class="col-2" DataLabel="Tip">@context.FileDate</MudTd>
                <MudTd Class="col-9" DataLabel="Denumire">@context.HospitalAdmissionDate</MudTd>
                <MudTd Class="col-9" DataLabel="Denumire">@context.DischargeDate</MudTd>
            </RowTemplate>
        -->
        <!--fara pager,ca nu sunt atat de multe-->
        <!--
        <PagerContent>
            <MudTablePager RowsPerPageString="Randuri pagina:" PageSizeOptions="@(new int[] { 5, 10, 25, 50 , int.MaxValue})"> R</MudTablePager>
        </PagerContent>
        -->
        <!-- </MudTable> -->
    </MudTabPanel>
    <MudTabPanel Text="Diagnostic Secundar">
        <StgMures.Client.Pages.Categories.DiagnosticCategories></StgMures.Client.Pages.Categories.DiagnosticCategories>

    </MudTabPanel>
</MudTabs>


<!--table list-->
<!--<MudTable @ref="@_table" Hover="true" Dense="true" Striped="true" Elevation="5" 
          Items="@patientsFiles" @bind-customer="currentPatientFile" OnRowClick="@RowClicked" T="PatientFile"> -->

          <!-- no filter: Items="@patientsFiles" Filter="new Func<PatientFile, bool>(Search)" @bind-customer="currentPatientFile" OnRowClick="@RowClicked" T="PatientFile"> -->

<!-- NU e cazul, vor fi 2-3 fise max
    <ToolBarContent>
        <MudSpacer />
        <MudTextField @bind-Value="searchString" Placeholder="Cautati o categorie..." Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.currentPatientFile" IconSize="Size.Small" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Nr.Fisa</MudTh>
        <MudTh>Data Fisa</MudTh>
        <MudTh>Data Internarii</MudTh>
        <MudTh>Data Externarii</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd Class="col-1" DataLabel="Id">@context.FileNumber</MudTd>
        <MudTd Class="col-2" DataLabel="Tip">@context.FileDate</MudTd>
        <MudTd Class="col-9" DataLabel="Denumire">@context.HospitalAdmissionDate</MudTd>
        <MudTd Class="col-9" DataLabel="Denumire">@context.DischargeDate</MudTd>
    </RowTemplate>
-->
<!--fara pager,ca nu sunt atat de multe-->
    <!--
    <PagerContent>
        <MudTablePager RowsPerPageString="Randuri pagina:" PageSizeOptions="@(new int[] { 5, 10, 25, 50 , int.MaxValue})"> R</MudTablePager>
    </PagerContent>
    -->
<!--</MudTable>-->




@code {

    [Parameter]
    public int? PatientId { get; set; }     
    // card design 
    private Patient _currentPatient = new Patient();
    private PatientFile currentPatientFile = new PatientFile();
 

    // table design
    private MudTable<PatientFile>? _table;  // deocamdata afisez lista de fise ale pacientului; 

    private List<PatientFile> patientsFiles = new List<PatientFile>();  // se pot selecta fisele, daca sunt mai multe.

    // data
    // Ar fi o idee sa afisez in fisa pacientului direct diagnosticele, dar in varianta 1 fac pagina separata.

    // private PatientFile currentPatientFile = new PatientFile() { Id = 0, Name = string.Empty };
    // private List<PatientFile> patientsFiles = new List<PatientFile>();

    protected override async Task OnInitializedAsync()
    {
        if (PatientId == 0)
        {
            snackBar.Add("Nici un pacient selectat", Severity.Warning);
            // ar trebui sa cer sa aleaga un pacient, dar probabil nu voi lasa doar navigarea din lista
        }
        SetAppMenuInfos.SetPageTitle("Fisa Pacient");
        SetAppMenuInfos.SetSelectedPatient(_currentPatient!.FirstName + " " + _currentPatient!.LastName);   // trebuie sa fie un pacient selectat. Daca nu e, ar trebui sa oblig alegerea unui pacient

        await patientFileService.LoadPatientFilesAsync();
        patientsFiles = patientFileService.PatientFiles;
        if (patientsFiles.Count == 0)
            EnableAll();

    }



    protected void RowClicked(TableRowClickEventArgs<PatientFile> clickedCategory)
    {
        if (_table!.GetFilteredItemsCount() == 0)
            EnableAll();
        if (_table!.SelectedItem == null)
            return;
        SelectCurrentItem(clickedCategory.Item.Id);
        EnableAll();
    }



    private async Task ValidateAction()
    {
        switch (_currentAction)
        {
            case (int)_actionbtn.None:
                DisableAll();            // Invalid action, disable all 
                return;
            case (int)_actionbtn.Add:
                await patientFileService.AddPatientFile(currentPatientFile);
                snackBar.Add("Inregistrare adaugata", Severity.Success);
                break;
            case (int)_actionbtn.Edit:
                await patientFileService.UpdatePatientFile(currentPatientFile);
                snackBar.Add("Inregistrare modificata", Severity.Success);
                break;
            case (int)_actionbtn.Delete:
                if (currentPatientFile.Id == 0)               // Invalid selection
                    return;
                await patientFileService.DeletePatientFile(currentPatientFile.Id);
                snackBar.Add("Inregistrare stearsa", Severity.Success);
                break;
        }

        _currentAction = 0;
        patientsFiles = patientFileService.PatientFiles;

        DisableAll();

        await Task.Delay(1); // let UI refresh
    }

    // movers
    private string searchString = "";

    private void SelectCurrentItem(int id)
    {
        currentPatientFile = patientsFiles.FirstOrDefault(c => c.Id == id);
    }

    private bool Search(PatientFile currentPatientFile)
    {
        if (string.IsNullOrWhiteSpace(searchString)) return true;
/*
        if (currentPatientFile.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
        {
            return true;
        }

*/
        return false;
    }

}
