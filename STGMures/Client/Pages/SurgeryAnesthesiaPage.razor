@page "/SurgeryAnesthesiaPage"

@using StgMures.Shared.DbModels
@inject MudBlazor.ISnackbar snackBar
@inherits _RazorPageBehaviorBase

@inject IPatientSurgeryService patientSurgeryService
@inject ISetAppMenuInfos SetAppMenuInfos

<MudGrid>
    <MudItem xs="12">
        <MudPaper  Elevation="5"> <!-- indentificare pacient (vreau sa-l pun in appbar)-->
            <MudGrid>
                <MudItem Class="d-inline-flex" >
                    <MudAutocomplete size="10" Disabled="false" @bind-Value="_selectedFile.FileNumber" HelperText="Numar fisa" Variant="Variant.Text" Margin="Margin.None" Class="d-inline-flex"></MudAutocomplete>
                    <MudTextField size="4" Disabled="false" @bind-Value="_selectedFile.FileDate" Variant="Variant.Text" Margin="Margin.None" Format="dd/mm/yyyy" InputType="InputType.Date" Class="d-inline-flex" HelperText="An"></MudTextField>
                </MudItem>
                <MudSpacer/>
                <MudItem >
                    <MudTextField size="4" Class="invisible" Disabled="true" @bind-Value="_selectedPatient.Id" Variant="Variant.Text" Margin="Margin.None"></MudTextField>
                </MudItem>
                <MudItem >
                    <MudTextField Disabled="true" @bind-Value="_selectedPatient.LastName" HelperText="Nume" Variant="Variant.Text"  Margin="Margin.None"></MudTextField>
                </MudItem>
                <MudItem >
                    <MudTextField Disabled="true" @bind-Value="_selectedPatient.FirstName" HelperText="Prenume" Variant="Variant.Text" Margin="Margin.None"></MudTextField>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>
    <MudDivider DividerType="DividerType.FullWidth" Class="border-3 border-solid mud-border-primary" />
    <p />
    <MudItem xs="6">    <!-- anestezii -->
        <MudPaper Elevation="5">
        <MudGrid>
            <MudItem xs="3">
                <MudTextField Disabled="@_disabledField" @bind-Value="anesthesia.Date" HelperText="Data anestezie" Format="dd/mm/yyyy" InputType="InputType.DateTimeLocal" Variant="Variant.Text" Margin="Margin.None" T="DateTime"></MudTextField>
            </MudItem>
            <MudItem xs="2">
                <MudNumericField Disabled="@_disabledField" @bind-Value="anesthesia.Duration" HelperText="Durata" Format="N2" Variant="Variant.Text" Margin="Margin.None" T="int"></MudNumericField>
            </MudItem>
            <MudItem xs="4">
                    <MudTextField Disabled="@_disabledField" @bind-Value="anesthesia.Name" HelperText="Descriere" Variant="Variant.Text" Margin="Margin.None"></MudTextField>
            </MudItem>
            <MudItem xs="2">
                    <MudSelect Disabled="@_disabledField" T="string" AnchorOrigin="Origin.BottomCenter" @bind-Value="anesthesia.Type" HelperText="Tip" Variant="Variant.Text" Margin="Margin.None">
                        @foreach (var _option in StaticParam.AnesthesiaType)
                        {
                            <MudSelectItem Value="@_option" />
                        }
                    </MudSelect>
            </MudItem>
        </MudGrid>

        <MudTable @ref="@_tableAnesthesia" Hover="true" Dense="true" Striped="true" Elevation="5" Bordered
                    Items="@anesthesias" @bind-customer="surgery" OnRowClick="@RowClicked" T="SurgeryAnesthesium">
            <HeaderContent>
                <MudTh>Data</MudTh>
                <MudTh>Durata</MudTh>
                <MudTh>Descriere</MudTh>
                <MudTh>Tip</MudTh>
            </HeaderContent>
            <RowTemplate>
            </RowTemplate>
        </MudTable>
    
        <MudDivider DividerType="DividerType.FullWidth" Class="border-3 border-solid mud-border-primary" />

        <MudGrid>
            <MudItem xs="3">
                <MudTooltip Text="Adauga o noua inregistrare">
                    <MudIconButton Disabled="@_disabledBtn" Icon="@Icons.Material.Filled.Add" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="AddNewRecord">Adauga</MudIconButton>
                </MudTooltip>

                <MudTooltip Text="Modifica inregistrarea selectata">
                    <MudIconButton Disabled="@_disabledBtn" Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="UpdateRecord">Modifica</MudIconButton>
                </MudTooltip>

                <MudTooltip Text="Sterge inregistrarea selectata">
                    <MudIconButton Disabled="@_disabledBtn" Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="DeleteRecord">Sterge</MudIconButton>
                </MudTooltip>
            </MudItem>
            <MudSpacer/>
            <MudItem xs="2">
                <MudTooltip Text="Validare">
                    <MudIconButton Disabled="@_disabledBtnValid" Icon="@Icons.Material.Filled.Save" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="ValidateAction">Ok</MudIconButton>
                </MudTooltip>
                <MudTooltip Text="Renuntare">
                    <MudIconButton Disabled="@_disabledBtnValid" Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="ClearCurrentSelection">Cancel</MudIconButton>
                </MudTooltip>
            </MudItem>
        </MudGrid>

        </MudPaper>
        </MudItem>

        <MudItem xs="6"> <!-- consumabile anestezii -->
        <MudPaper Elevation="5">
        <MudGrid>
            <MudItem xs="4">
                    <MudTextField Disabled="@_disabledField" @bind-Value="consumable.ConsumableId" HelperText="Consumabil" Variant="Variant.Text" Margin="Margin.None" T="int"></MudTextField>
            </MudItem>
            <MudItem xs="2">
                <MudTextField Disabled="@_disabledField" @bind-Value="consumable.Value" HelperText="@_helperValue" Variant="Variant.Text" Margin="Margin.None" T="string"></MudTextField>
            </MudItem>
                <MudItem xs="2">
                    <MudTextField Disabled="@_disabledField" @bind-Value="@_consumableUm" HelperText="UM" Variant="Variant.Text" Margin="Margin.None" T="string"></MudTextField>
                </MudItem>
                <MudItem xs="4">
                <MudTextField Disabled="@_disabledField" @bind-Value="consumable.ShortNote" HelperText="Obs" Variant="Variant.Text" Margin="Margin.None"></MudTextField>
            </MudItem>
        </MudGrid>

        <MudTable @ref="@_tableAnesthesia" Hover="true" Dense="true" Striped="true" Elevation="5" Bordered
                    Items="@anesthesias" @bind-customer="surgery" OnRowClick="@RowClicked" T="SurgeryAnesthesium">
            <HeaderContent>
                <MudTh>Consumabil</MudTh>
                <MudTh>@_helperValue</MudTh>
                <MudTh>UM</MudTh>
                <MudTh>Obs</MudTh>
            </HeaderContent>
            <RowTemplate>
            </RowTemplate>
        </MudTable>

        <MudDivider DividerType="DividerType.FullWidth" Class="border-3 border-solid mud-border-primary" />

        <MudGrid>
            <MudItem xs="3">
                <MudTooltip Text="Adauga o noua inregistrare">
                    <MudIconButton Disabled="@_disabledBtn" Icon="@Icons.Material.Filled.Add" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="AddNewRecord">Adauga</MudIconButton>
                </MudTooltip>

                <MudTooltip Text="Modifica inregistrarea selectata">
                    <MudIconButton Disabled="@_disabledBtn" Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="UpdateRecord">Modifica</MudIconButton>
                </MudTooltip>

                <MudTooltip Text="Sterge inregistrarea selectata">
                    <MudIconButton Disabled="@_disabledBtn" Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="DeleteRecord">Sterge</MudIconButton>
                </MudTooltip>
            </MudItem>
            <MudSpacer />
            <MudItem xs="2">
                <MudTooltip Text="Validare">
                    <MudIconButton Disabled="@_disabledBtnValid" Icon="@Icons.Material.Filled.Save" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="ValidateAction">Ok</MudIconButton>
                </MudTooltip>
                <MudTooltip Text="Renuntare">
                    <MudIconButton Disabled="@_disabledBtnValid" Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" Variant="Variant.Text" Color="Color.Success" OnClick="ClearCurrentSelection">Cancel</MudIconButton>
                </MudTooltip>
            </MudItem>
        </MudGrid>

        </MudPaper>
        </MudItem>


</MudGrid>






            @code {
    // card design
    private Patient        _selectedPatient = new ();       // parameter
    private PatientFile    _selectedFile    = new   ();     // parameter   
    private PatientSurgery _selectedSurgery = new ();       // parameter

    private SurgeryAnesthesium anesthesia = new();      
    private List<SurgeryAnesthesium>    anesthesias = new();  // lista anesteziilor pentru operatia curenta

    private AnesthesiaConsumable        consumable= new();    // selected from consumables  
    private List<AnesthesiaConsumable> _consumables = new();  // lista anesteziilor pentru operatia curenta

    // table design
    private MudTable<SurgeryAnesthesium>? _tableAnesthesia;
    private MudTable<AnesthesiaConsumable>? _tableConsumable;

    private string _helperValue = "Qtty";   // changed 
    private string _consumableUm = "gr.";   // changed

    // data
    private PatientSurgery surgery = new PatientSurgery();
    private List<PatientSurgery> surgeries = new List<PatientSurgery>();

    protected override async Task OnInitializedAsync()
    {
        SetAppMenuInfos.SetPageTitle("Pregatire operatie - Anestezie");
        await Task.Delay(1);
        EnableCurrentSelection();
        /* patientSurgeryService.LoadPatientSurgeriesAsync();
        surgeries = patientSurgeryService.PatientSurgeries;
        if (surgeries.Count == 0)
            EnableCurrentSelection();
*/
    }



    protected void RowClicked(TableRowClickEventArgs<SurgeryAnesthesium> clickedCategory)
    {
        if (_tableAnesthesia!.GetFilteredItemsCount() == 0)
            EnableCurrentSelection();
        if (_tableAnesthesia!.SelectedItem == null)
            return;
        SelectCurrentItem(clickedCategory.Item.Id);
        EnableCurrentSelection();
    }



    private async Task ValidateAction()
    {
        switch (_currentAction)
        {
            case (int)_actionbtn.None:
                ClearCurrentSelection();            // Invalid action, disable all
                return;
            case (int)_actionbtn.Add:
                await patientSurgeryService.AddPatientSurgery(surgery);
                snackBar.Add("Inregistrare adaugata", Severity.Success);
                break;
            case (int)_actionbtn.Edit:
                await patientSurgeryService.UpdatePatientSurgery(surgery);
                snackBar.Add("Inregistrare modificata", Severity.Success);
                break;
            case (int)_actionbtn.Delete:
                if (surgery.Id == 0)               // Invalid selection
                    return;
                await patientSurgeryService.DeletePatientSurgery(surgery.Id);
                snackBar.Add("Inregistrare stearsa", Severity.Success);
                break;
        }

        _currentAction = 0;
        surgeries = patientSurgeryService.PatientSurgeries;

        ClearCurrentSelection();

        await Task.Delay(1); // let UI refresh
    }

    // movers
    private string searchString = "";

    private void SelectCurrentItem(int id)
    {
        surgery = surgeries.FirstOrDefault(c => c.Id == id);
    }

    private bool Search(PatientSurgery surgery)
    {
        if (string.IsNullOrWhiteSpace(searchString)) return true;
        /*
                if (surgery.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                {
                    return true;
                }
        */

        return false;
    }

}
